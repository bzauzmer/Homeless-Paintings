<!DOCTYPE html>
<meta charset="utf-8">
<title>Homeless Paintings of the Italian Renaissance</title>
<style>

  body {
     font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif; 
     font-weight: 300;    
     font-size: 10pt;
     background-color: #d0ffff;   
  }

  table {
    background-color: #b0ffff;
  }

  .link {
    stroke: gray;
  }

  .node {
    fill: blue;
    stroke: #000;
    stroke-width: 0px;
  }

  .node:hover {
    fill: red;
  }

  a {text-decoration: underline;}
  a:link {color: #0000FF;}
  a:visited {color: #800080;}
  a:active {color: #FF0000;}

  .axis text {
  font: 10px sans-serif;
  }

  .axis path,
  .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

  .bar rect{
    fill: steelblue;
  }

  .bar rect:hover {
    fill: brown;
  }

  .bar.tooltip {   
    position: absolute;           
    text-align: left;                      
    font: 12px;        
    background: lightgray;   
    border: 5px;      
    border-radius: 8px;           
    pointer-events: none;         
  }

  img {
    display: block;
    margin-left: auto;
    margin-right: auto
  }

  .line {
    fill: none;
    stroke: steelblue;
    stroke-width: 1.5px;
  }

  .centered {

    text-align: center;
  }

</style>
<body>

<h4>
Homeless Paintings of the Italian Renaissance<br>
Jason Mahr, Linda Song, and Ben Zauzmer
</h4>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <form>
  Layout:
    <label><input type="radio" name="layout" value="force" checked> Force</label>
    <label><input type="radio" name="layout" value="radial"> Radial</label>
    <label><input type="radio" name="layout" value="map"> Map</label>
    <label><input type="radio" name="layout" value="timeline"> Timeline</label>
    <label><input type="radio" name="layout" value="wordcloud"> Word Cloud</label>
  </form>
  
  <table border="1">
    <tr>
      <td class="vis" rowspan="2"></td>
      <td class="filters" width="200" height="270"></td>
      <td class="focus"></td>
    </tr>
    <tr>
      <td class="bar" colspan="2">
      <!-- // making menu dropdown for the bar graph -->
      <p id="menu"><b>Bar Graph</b><br>Select series: <select>
        <option value="Artists">Artist vs Number of Paintings Missing</option>
        <option value="Years">Decade vs Number of Paintings Missing</option>
      </select>
      </td>
    </tr>
  </table>

<script>

//Margins, where bar_height is the height of the bar graph cell
// var width = 750, height = 500, bar_height = 200;
var width = 1280, height = 720, bar_height = 200;

// variables for the bar graph
var svg_barwidth = 400;

//making margins
var bar_margin = { top: 30, right: 40, bottom: 50, left: 50 };

//Create svg's for vis and bar
var svg_vis = d3.select(".vis").append("svg").attr("width", width).attr("height", height);
var svg_bar = d3.select(".bar").append("svg").attr("width", svg_barwidth).attr("height",bar_height);

//Add filler text to the non-vis cells
d3.select(".filters").append("p").attr("class", "centered").text("Filters:").attr("style","font-weight:bold");
d3.select(".filters").append("p").attr("class", "p_num").text("Number of Paintings:");
d3.select(".focus").append("p").attr("class", "centered").text("Click on a node!");

//Create drop-down for number of paintings
d3.select(".p_num")
  .append("select")
  .attr("class","num")
  .selectAll("option")
  .data([10,20,30,40,50,100,11189])
  .enter()
  .append("option")
  .text(function (d) {return d;})
  .attr("value", function (d) {return d;});

d3.select(".filters").append("p").attr("class", "p_city").text("City:");

var cities = ['All','Bologna','Catania','Florence','Genoa','Messina','Milan','Naples','Padua','Palermo','Rome','Trieste','Turin','Venice','Verona'];

//Create drop-down for number of paintings
d3.select(".p_city")
  .append("select")
  .attr("class","city")
  .selectAll("option")
  .data(cities)
  .enter()
  .append("option")
  .text(function (d) {return d;})
  .attr("value", function (d) {return d;});

d3.select(".filters").append("p").attr("class", "p_artist").text("Artist:");

d3.select(".p_artist")
  .append("select")
  .attr("class","artist")
  .selectAll("option")
  .data(['All'])
  .enter()
  .append("option")
  .text(function (d) {return d;})
  .attr("value", function (d) {return d;});

//Makevis on initial page load
makevis();

//This is the main funciton that creates the visualization
function makevis() {

  //Remove all nodes, links, and dynamic drop-downs
  d3.selectAll(".node").remove();
  d3.selectAll(".link").remove();

  //Radio buttons should start with force checked
  d3.selectAll("input").each(function(d) {
    
    if (d3.select(this).attr("value") == 'force') {
     
      d3.select(this).node().checked = true;
    }
  });

  //Create structure for force diagram
  var graph = {nodes:[], links:[]};

  // make an array of objects with the artist name and its corresponding number of missing paintings
  var artist_obj = [];
  var obj_array = [];

  //make an array of the dates total
  var date_array = [];
  var date_objarray = [];

  //make an array of the cities
  var city_obj = [];

  // make an array of topic totals
  var topics_array = [];
  var topics_objarray = [];

  // make an array for topics that also includes painting id
  var topics_id = [];

  //Load data - data_text is only the first 10 entries
  //Will be changed to a CSV
  d3.csv("data.csv", function(data) {

    // counting the strange 0's that appear after counting paintings
    var zero_count = 0;
    var t_zerocount = 0;

    //Loop through paintings
    for (var i = 0; i < d3.select(".num").node().value; i++) {

      //Check if city matches selection
      if (d3.select(".city").node().value == 'All' || d3.select(".city").node().value == data[i]['city']) {
     
        //Check if artist matches selection
        if (d3.select(".artist").node().value == 'All' || d3.select(".artist").node().value == data[i]['artist']) {

          //Add node for each painting
          graph.nodes.push({
            painting: data[i]['painting'],
            artist: data[i]['artist'],
            record: data[i]['record'],
            image: data[i]['image'],
            date: data[i]['date'],
            city: data[i]['city'],
            topics: data[i]['topics']
          });

          // if the artist isn't already in the array, create the counter to be set to 0
          if (!artist_obj[data[i]['artist']]) {
            artist_obj.push(artist_obj[data[i]['artist']] = 0);
            zero_count++;
          } 

          // parse date
          if (!date_array[data[i]['date']]) {
            date_array.push(date_array[data[i]['date']] = 0);
          }

          // if the city isn't already in the array, create the counter to be set to 0
          if (data[i]['city'] && !city_obj[data[i]['city']]) {
            city_obj.push(city_obj[data[i]['city']] = 0);
          }

          // parse strings representing topic lists
          if (graph.nodes[i].topics) {
            // to store list of topics for current painting in an array of strings; list is currently a string
            var ts = graph.nodes[i].topics.slice(3,-2).split("', u'");

            // parse topics
            ts.forEach(function(t) {
              if (!topics_array[t]) {
                topics_array.push(topics_array[t] = 1);
                t_zerocount++;
              } else {
                ++topics_array[t];
              }
            });
          };

          // increase the counter by 1 per occurance
          ++artist_obj[data[i]['artist']];
          ++date_array[data[i]['date']];

          if (data[i]['city']) {
            ++city_obj[data[i]['city']];
          }
        }
      }
    }

    d3.select(".artist").remove();

    // to remove extraneous zeros
    for (var j = 0; j < zero_count; j++) {
      artist_obj.shift();
      city_obj.shift();
    }

    // to remove extraneous zeros for topics
    for (var k = 0; k < t_zerocount; k++) {
      topics_array.shift();
    }

    // filtering out dup keys for artists
    for (artist in artist_obj) {
      obj_array.push({ artist: artist, value: artist_obj[artist] })
    }

    // filtering out dup keys for topics
    for (topic in topics_array) {
      topics_objarray.push({topic: topic, value: topics_array[topic]})
    }

    // parsing dates
    for (date in date_array) {
      date_objarray.push({ date: parseInt(date), value: date_array[date] });
    }

    //Create array of current artists
    var key_arr = Object.keys(artist_obj);

    //Add 'All' as the first option
    key_arr.unshift('All');

    //Create drop-down for aritst
    d3.select(".p_artist")
      .append("select")
      .attr("class","artist")
      .selectAll("option")
      .data(key_arr)
      .enter()
      .append("option")
      .text(function (d) {return d;})
      .attr("value", function (d) {return d;});

    //If drop-down is changed, makevis
    d3.selectAll("select").on("change", makevis);

    //Function that returns intersection of two arrays
    function intersect(a, b) {
      var t;
      if (b.length > a.length) t = b, b = a, a = t;
      return a.filter(function (e) {
          if (b.indexOf(e) !== -1) return true;
      });
    }

    //Loop through nodes
    for(var i = 0; i < graph.nodes.length; i++) {

      //Loop through nodes a second time for pairwise comparison
      for (var j = i + 1; j < graph.nodes.length; j++) {

        //Determine size of intersection
        var overlap = intersect(data[i]['topics'].slice(3,data[i]['topics'].length-2).split("', u'"), data[j]['topics'].slice(3,data[j]['topics'].length-2).split("', u'")).length;

        //Check if the nodes share any topics
        if (overlap) {

          //Add link if the nodes share a topic
          graph.links.push({"source": i, "target": j, "overlap": overlap});
        }
      }
    }

    //Create scale for timeline
    var yearScale = d3.scale.linear().domain([1300,1600]).range([100,width-100]);

    //Generate the force layout
    var force = d3.layout.force()
        .size([width, height])
        .charge(-50)
        .linkDistance(200)
        .on("tick", tick)
        .on("start", function(d) {})
        .on("end", function(d) {})

    //Part of the force layout
    function tick(d) {

      graph_update(0);
    }

    //Start force layout if radio button selected
    function force_layout() {

      //Delete map, text and x-axis
      svg_vis.select("image").remove();
      svg_vis.selectAll("text").remove();
      d3.select(".xaxis").remove();

      //Reset nodes and links
      d3.selectAll("circle").attr("r",5);
      svg_vis.selectAll(".link").style("stroke-width", function(d) {return d.overlap;});

      //Start force
      force.nodes(graph.nodes)
          .links(graph.links)
          .start();
    }

    //Start radial layout if radio button selected
    function radial_layout() {

      //Stop force
      force.stop();

      //Delete map, text, and x-axis
      svg_vis.select("image").remove();
      svg_vis.selectAll("text").remove();
      d3.select(".xaxis").remove();

      //Reset nodes and links
      d3.selectAll("circle").attr("r",5);
      svg_vis.selectAll(".link").style("stroke-width", function(d) {return d.overlap;});

      var r = height/2;

      var arc = d3.svg.arc().outerRadius(r);

      var pie = d3.layout.pie()
      .sort(function(a, b) { return a.cat - b.cat;})
              .value(function(d, i) { return 1; }); // equal share for each point

      graph.nodes = pie(graph.nodes).map(function(d, i) {
        d.innerRadius = 0;
        d.outerRadius = r;
        d.data.x = arc.centroid(d)[0]+height/2;
        d.data.y = arc.centroid(d)[1]+width/2;
        d.data.endAngle = d.endAngle; 
        d.data.startAngle = d.startAngle; 
        return d.data;
      })

      graph_update(500);
    }

    //Start map layout if radio button selected
    function map_layout() {

      //Stop force
      force.stop();

      //Delete x-axis
      d3.select(".xaxis").remove();

      //Add map of Italy
      svg_vis.append('image')
        .attr("xlink:href", "Italy map.jpg")
        .attr("x", "150")
        .attr("width", "500")
        .attr("height", "500");

      //Hide links
      svg_vis.selectAll(".link").style("stroke-width", 0);

      //Open coordinates json file
      d3.json("Coordinates.json", function(json) {

        //Loop through nodes
        for (var i = 0; i < node[0].length; i++) {

          //Check if node has city
          if (node[0][i]['__data__'].city) {

            //Set coordinates by city
            node[0][i]['__data__'].x = json[node[0][i]['__data__'].city].x;
            node[0][i]['__data__'].y = json[node[0][i]['__data__'].city].y;
          }
        }

        //Hide nodes without cities
        svg_vis.selectAll("circle").attr("r",function (d) {if (d.city) {return 5;} else {return 0;}});

        //Remove 'All' from cities
        cities.shift();

        //Add city labels (red if city has nodes)
        svg_vis.selectAll("text")
          .data(cities)
          .enter()
          .append("text")
          .text(function (d) {return d;})
          .attr("x", function (d) {return json[d].x + 8;})
          .attr("y", function (d) {return json[d].y + 5;})
          .attr("style", function (d) {
            if (Object.keys(city_obj).indexOf(d) > -1) {
              return "fill: #ff0000"
            }
          });

        graph_update(500);

      });
    }

    //Start timeline layout if radio button selected
    function timeline_layout() {

      //Stop force
      force.stop();

      //Delete map and text
      svg_vis.select("image").remove();
      svg_vis.selectAll("text").remove();


      //Reset nodes and links
      d3.selectAll("circle").attr("r",5);
      svg_vis.selectAll(".link").style("stroke-width", function(d) {return d.overlap;});

      //Loop through nodes
      for (var i = 0; i < node[0].length; i++) {

        //Move to timeline
        node[0][i]['__data__'].x = yearScale(node[0][i]['__data__'].date);
        node[0][i]['__data__'].y = 250;
      }

      //Define x-axis
      var xAxis = d3.svg.axis()
        .scale(yearScale)
        .orient("bottom")
        .ticks(6,"d")
        .tickSize(6,2);

      //Add x-axis
      svg_vis.append("g")
        .attr("class", "xaxis")
        .attr("transform", "translate(0,250)")
        .call(xAxis);

      graph_update(500);
    }

    //Start word cloud layout if radio button selected
    function wordcloud_layout() {

      //Stop force
      force.stop();

      //Delete map and x-axis
      svg_vis.select("image").remove();
      d3.select(".xaxis").remove();

      //Hide nodes and links
      svg_vis.selectAll("circle").attr("r",0);
      svg_vis.selectAll(".link").style("stroke-width", 0);

      var color = d3.scale.category20c();

      // padding from margins
      var tpad = 100;
      
      var tnode = svg_vis.selectAll(".tnode")
        .data(topics_objarray)
        .enter().append("g")
        .attr("class","tnode")
        .attr("transform", function(d) { return "translate(" + (Math.floor((Math.random() * (width-tpad*2)))+tpad) + "," + (Math.floor((Math.random() * (height-tpad*2)))+tpad) + ")";});

      // tnode.append("title")
      //   .text(function(d) {return d.topic;});

      tnode.append("circle")
        .attr("r", function(d) {return 20 + d.value * 3;})
        .style("fill", function(d) {return color(d.topic);});

      tnode.append("text")
        .attr("dy",".3em")
        .attr("font","10px sans-serif")
        .style("text-anchor","middle")
        // .text(function(d) {return d.topic;});
        // I want to make the things more legible
        .text(function(d) {
          //return d.topic.substr(0,d.topic.indexOf(' '));
          return d.topic.replace(/([a-zA-Z]+)(.*)/,'$1');
        });

      graph_update(500);
    }

  //Update graph via smooth transition
    function graph_update(delay) {

      //Transition links
      link.transition().duration(delay)
          .attr("x1", function(d) { return d.target.x; })
          .attr("y1", function(d) { return d.target.y; })
          .attr("x2", function(d) { return d.source.x; })
          .attr("y2", function(d) { return d.source.y; });

      //Transition nodes
      node.transition().duration(delay)
          .attr("transform", function(d) { 
            return "translate("+d.x+","+d.y+")"; 
          });
    }

    //Enable radio buttons
    d3.select("input[value=\"force\"]").on("click", force_layout);
    d3.select("input[value=\"radial\"]").on("click", radial_layout);
    d3.select("input[value=\"map\"]").on("click", map_layout);
    d3.select("input[value=\"timeline\"]").on("click", timeline_layout);
    d3.select("input[value=\"wordcloud\"]").on("click", wordcloud_layout);

    //Create nodes
    var node = svg_vis.selectAll(".node")
                  .data(graph.nodes)
                .enter()
                  .append("g").attr("class", "node");

    //Create links
    var link = svg_vis.selectAll(".link")
                .data(graph.links)
                .enter().insert("svg:line","g.node")
                .attr("class", "link")
                //Link thickness by number of overlapping topics
                .style("stroke-width", function(d) {return d.overlap;});

    //Add circles to nodes
    node.append("circle")
        .attr("r", 5)
        .on('click', function(d) {

          //Text-align left once first node is clicked
          d3.select(".focus").style("text-align", "left");
          d3.selectAll(".focus text").remove();

          //Remove previous image and text from focus
          d3.select(".focus img").remove();
          d3.selectAll(".focus p").remove();

          //Add clicked image to focus
          d3.select(".focus").append("img")
            .attr("src",d.image)
            .style("text-align", "center")
            .attr("width",125)
            .attr("height",125);
          
          //Add clicked text to focus
          d3.select(".focus").append("p").text("Painting: " + d.painting);
          d3.select(".focus").append("p").text("Artist: " + d.artist);
          d3.select(".focus").append("p").text("Record number: " + d.record);
          d3.select(".focus").append("p").text("Year: " + d.date);
          d3.select(".focus").append("p").append("a").attr("href", "http://images.google.com/searchbyimage?image_url=" + d.image).attr("target","_blank")
            .text("Reverse Image Search");

        })
        //Tooltip on hover
        .append("svg:title")
          .text(function(d) { return "Painting: " + d.painting + "\nArtist: " + d.artist + "\nRecord number: " + d.record; });

    //Default layout is force
    force_layout();

    // generates bar graph depending on the value of the chosen dropdown menu
    function generateBarGraph() {

      // making an array to hold only the number of missing paintings per artist
      var paintingsMissing = [];
      var artists_array = [];

      // looping through the missing paintings count array to push the number of paintings missing regardless of artist into an array
      for(var artist in artist_obj) {
        paintingsMissing.push(artist_obj[artist]);
        artists_array.push(artist);
      }

      // // clear the current graph 
      d3.selectAll("rect").remove()
      d3.selectAll(".bar").selectAll("text").remove()

      var series = menu.property("value");

      if (series == "Artists") {
        createArtistMissing(artists_array, paintingsMissing);
      } else if (series == "Years") {
        createDecadeMissing(artists_array, paintingsMissing);
      }
    } 

    // creates bar graph (artist vs painting)
    function createArtistMissing(artists_array, paintingsMissing) {

      // making the scales 
      var x = d3.scale.ordinal()
        .domain(artists_array)
        .rangeRoundBands([bar_margin.right, svg_barwidth], .1)

      var y = d3.scale.linear()
        .domain([0, d3.max(paintingsMissing)])
        .range([bar_height - bar_margin.bottom,0])

      // making the axes
      var xAxis = d3.svg.axis()
          .scale(x)
          .orient("bottom");

      var yAxis = d3.svg.axis()
          .scale(y)
          .orient("left")

      // for tooltip
      var div = d3.select(".bar").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

      // rotating the labels on the x axis
      svg_bar.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + (bar_height - bar_margin.bottom) + ")")
          .call(xAxis)
          .selectAll("text")  
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("transform", function(d) {
                return "rotate(-65)" 
                });

      // y axis made
      svg_bar.append("g")
          .attr("class", "y axis")
          .attr("transform", "translate(" + bar_margin.right + ",0)" )
          .call(yAxis)
          .append("text")
          .style("text-anchor", "end")
          .text("Missing Paintings");

      // creating the bars themselves
      svg_bar.selectAll(".bar")
          .data(obj_array)
        .enter().append("rect")
          .attr("class", "bar")
          .attr("x", function(d) { return x(d.artist); })
          .attr("y", function(d) { return y(d.value) - bar_margin.bottom; })
          .attr("height", function(d) { return bar_height - y(d.value); })
          .attr("width", x.rangeBand())
          .attr("opacity", .9)

          // for mouseover details
          .on("mouseover", function(d) {
            div.transition()
              .duration(200)
              .style("opacity", .9);
            div.html("<b>" + "Artist: " + "</b>" + d.artist + "<br>")
              .style("left", (d3.event.pageX) + "px")
              .style("top", (d3.event.pageY - 28) + "px");
          })
          .on("mouseout", function(d) {
            div.transition()
              .duration(500)
              .style("opacity", 0);
          })
    }

    // function that updates the graph to linear vs linear line graph
    function createDecadeMissing(artists_array, paintingsMissing) {
      console.log(date_array);
      console.log(date_objarray);

      // making the linear scales
      var x = d3.scale.linear()
        .domain(d3.extent(Object.keys(date_array)))
        .range([bar_margin.right, svg_barwidth])

      var y = d3.scale.linear()
        .domain([0, d3.max(paintingsMissing)])
        .range([bar_height - bar_margin.bottom,0])

      // creating the axes
      var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom")

      var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")

      svg_bar.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + (bar_height - bar_margin.bottom) + ")")
          .call(xAxis)
          .append("text")  
          // .style("text-anchor", "end")
          .text("Decade");

      svg_bar.append("g")
          .attr("class", "y axis")
          .attr("transform", "translate(" + bar_margin.right + ",0)" )
          .call(yAxis)
          .append("text")
          .style("text-anchor", "end")
          .text("Missing Paintings");

      svg_bar.selectAll(".bar")
          .data(date_objarray)
        .enter().append("rect")
          .attr("class", "bar")
          .attr("x", function(d) { return x(d.date); })
          .attr("y", function(d) { return y(d.value) - bar_margin.bottom; })
          .attr("height", function(d) { return bar_height - y(d.value); })
          .attr("width", (svg_barwidth - bar_margin.left)/(date_objarray.length));


    }

    // update bar graph when menu selection is changed    
    var menu = d3.select("#menu select")
    .on("change", generateBarGraph); 

    generateBarGraph();

  })
}

</script>
</body>
</html>