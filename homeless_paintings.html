<!DOCTYPE html>
<meta charset="utf-8">
<title>Homeless Paintings of the Italian Renaissance</title>
<style>

  body {
     font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif; 
     font-weight: 300;    
     font-size: 10pt;
     background-color: #d0ffff;   
  }

  table {
    background-color: #b0ffff;
  }

  .link {
    stroke: gray;
    stroke-width: 1.5px;
  }

  .node {
    fill: blue;
    stroke: #000;
    stroke-width: 1px;
  }

  .node:hover {
    fill: red;
  }

  a {text-decoration: underline;}
  a:link {fill: #0000FF;}
  a:visited {fill: #800080;}
  a:active {fill: #FF0000;}

</style>
<body>

<h4>
Homeless Paintings of the Italian Renaissance<br>
Jason Mahr, Linda Song, and Ben Zauzmer
</h4>

<script src="http://d3js.org/d3.v3.min.js"></script>
  <form>
  Layout:
    <label><input type="radio" name="layout" value="force" checked> Force</label>
    <label><input type="radio" name="layout" value="radial"> Radial</label>
    <label><input type="radio" name="layout" value="map"> Map</label>
    <label><input type="radio" name="layout" value="timeline"> Timeline</label>
    <label><input type="radio" name="layout" value="wordcloud"> Word Cloud</label>
  </form>
  
  <table border="1">
    <tr>
      <td class="vis" rowspan="2"></td>
      <td class="filters"></td>
      <td class="focus"></td>
    </tr>
    <tr>
      <td class="bar" colspan="2">
      <!-- // making menu dropdown for the bar graph -->
      <p id="menu"><b>Bar Graph</b><br>Select series: <select>
<!--         <option value="Years">Decade vs Number of Paintings Missing</option> -->
        <option value="Artists">Artist vs Number of Paintings Missing</option>
      </select>
      </td>
    </tr>
  </table>

<script>

//Margins, where bar_height is the height of the bar graph cell
var width = 750, height = 500, bar_height = 200;

// variables for the bar graph
var svg_barwidth = 400;

//Create one svg for each of the four cells
var svg_vis = d3.select(".vis").append("svg").attr("width", width).attr("height", height);
var svg_focus = d3.select(".focus").append("svg").attr("width",200).attr("height",height-bar_height);
var svg_bar = d3.select(".bar").append("svg").attr("width", svg_barwidth).attr("height",bar_height);

//Add filler text to the non-vis cells
d3.select(".filters").append("p").text("Filters:").attr("style","font-weight:bold");
d3.select(".filters").append("text").text("Number of Paintings:");
svg_focus.append("text").text("Click on a node!").attr("y",50);
svg_bar.append("text").text("The bar graph will go here.").attr("y",50);

//Create drop-down for number of paintings
d3.select(".filters")
  .append("select")
  .attr("class","num")
  .selectAll("option")
  .data([10,20,30,40,50])
  .enter()
  .append("option")
  .text(function (d) {return d;})
  .attr("value", function (d) {return d;});

//If drop-down is changed, makevis
d3.select("select").on("change", makevis);

//Makevis on initial page load
makevis();

//This is the main funciton that creates the visualization
function makevis() {

  d3.selectAll(".node").remove();
  d3.selectAll(".link").remove();

  //Create structure for force diagram
  var graph = {nodes:[], links:[]};

  // make an array of objects with the artist name and its corresponding number of missing paintings
  var artist_obj = [];

  //Load data - data_text is only the first 10 entries
  //Will be changed to a CSV
  d3.csv("data.csv", function(data) {

    // counting the strange 0's that appear after counting paintings
    var zero_count = 0;

    //Loop through paintings
    for (var i = 0; i < d3.select(".num").node().value; i++) {
     
      //Add node for each painting
      graph.nodes.push({
        painting: data[i]['painting'],
        artist: data[i]['artist'],
        record: data[i]['id'],
        image: data[i]['image'],
        date: data[i]['date']
      });

      // if the artist isn't already in the array, create the counter to be set to 0
      if (!artist_obj[graph.nodes[i].artist]) {
        // console.log(artist_obj[graph.nodes[i].artist]);
        artist_obj.push(artist_obj[graph.nodes[i].artist] = 0)
        zero_count++;
      } 
      // increase the counter by 1 per occurance
      ++artist_obj[graph.nodes[i].artist];

    }

    // to remove extraneous zeros
    for (var j = 0; j < zero_count; j++) {
      artist_obj.shift();
    }

    // error checking
    console.log(artist_obj);

    //Function that returns intersection of two arrays
    function intersect(a, b) {
      var t;
      if (b.length > a.length) t = b, b = a, a = t;
      return a.filter(function (e) {
          if (b.indexOf(e) !== -1) return true;
      });
    }

    //Loop through nodes
    for(var i = 0; i < graph.nodes.length; i++) {

      //Loop through nodes a second time for pairwise comparison
      for (var j = i + 1; j < graph.nodes.length; j++) {

        //Determine size of intersection
        var overlap = intersect(data[i]['topics'].slice(3,data[i]['topics'].length-2).split("', u'"), data[j]['topics'].slice(3,data[j]['topics'].length-2).split("', u'")).length;

        //Check if the nodes share any topics
        if (overlap) {

          //Add link if the nodes share a topic
          graph.links.push({"source": i, "target": j, "overlap": overlap});
        }
      }
    }

    var yearScale = d3.scale.linear().domain([1300,1600]).range([100,width-100]);

    //Generate the force layout
    var force = d3.layout.force()
        .size([width, height])
        .charge(-50)
        .linkDistance(200)
        .on("tick", tick)
        .on("start", function(d) {})
        .on("end", function(d) {})

    //Part of the force layout
    function tick(d) {

      graph_update(0);
    }

    //Start force layout if radio button selected
    function force_layout() {

      d3.select(".xaxis").remove();

      force.nodes(graph.nodes)
          .links(graph.links)
          .start();
    }

    //Start radial layout if radio button selected
    function radial_layout() {

      force.stop();
      d3.select(".xaxis").remove();

      var r = height/2;

      var arc = d3.svg.arc().outerRadius(r);

      var pie = d3.layout.pie()
      .sort(function(a, b) { return a.cat - b.cat;})
              .value(function(d, i) { return 1; }); // equal share for each point

      graph.nodes = pie(graph.nodes).map(function(d, i) {
        d.innerRadius = 0;
        d.outerRadius = r;
        d.data.x = arc.centroid(d)[0]+height/2;
        d.data.y = arc.centroid(d)[1]+width/2;
        d.data.endAngle = d.endAngle; 
        d.data.startAngle = d.startAngle; 
        return d.data;
      })

      graph_update(500);
    }

    //Start timeline layout if radio button selected
    function timeline_layout() {

      force.stop();

      for (var i = 0; i < node[0].length; i++) {

        node[0][i]['__data__'].x = yearScale(node[0][i]['__data__'].date);
        node[0][i]['__data__'].y = 250;
      }

      var xAxis = d3.svg.axis()
        .scale(yearScale)
        .orient("bottom")
        .ticks(6,"d")
        .tickSize(6,2);

      svg_vis.append("g")
        .attr("class", "xaxis")
        .attr("transform", "translate(0,250)")
        .call(xAxis);

      graph_update(500);
    }

    //Update graph via smooth transition
    function graph_update(delay) {

      link.transition().duration(delay)
          .attr("x1", function(d) { return d.target.x; })
          .attr("y1", function(d) { return d.target.y; })
          .attr("x2", function(d) { return d.source.x; })
          .attr("y2", function(d) { return d.source.y; });

      node.transition().duration(delay)
          .attr("transform", function(d) { 
            return "translate("+d.x+","+d.y+")"; 
          });
    }

    //Enable radio buttons (last three are commented out until implementation)
    d3.select("input[value=\"force\"]").on("click", force_layout);
    d3.select("input[value=\"radial\"]").on("click", radial_layout);
    //d3.select("input[value=\"map\"]").on("click", map_layout);
    d3.select("input[value=\"timeline\"]").on("click", timeline_layout);
    //d3.select("input[value=\"wordcloud\"]").on("click", wordcloud_layout);

    //Create nodes
    var node = svg_vis.selectAll(".node")
                  .data(graph.nodes)
                .enter()
                  .append("g").attr("class", "node");

    //Create links
    var link = svg_vis.selectAll(".link")
                .data(graph.links)
                .enter().insert("svg:line","g.node")
                .attr("class", "link")
                //Link thickness by number of overlapping topics
                .style("stroke-width", function(d) {return d.overlap;});

    //Add circles to nodes
    node.append("circle")
        .attr("r", 5)
        .on('click', function(d) {

          //Remove previous image and text from focus
          svg_focus.selectAll("image").remove();
          svg_focus.selectAll("text").remove();

          //Add clicked image to focus
          svg_focus.append("svg:image")
            .attr("xlink:href",d.image)
            .attr("width",125)
            .attr("height",125)
            .attr("x",35)
            .attr("y",30)
          
          //Add clicked text to focus
          svg_focus.append("text").text("Painting: " + d.painting).attr("y",175);
          svg_focus.append("text").text("Artist: " + d.artist).attr("y",200);
          svg_focus.append("text").text("Record number: " + d.record).attr("y",225);
          svg_focus.append("text").text("Year: " + d.date).attr("y",250);
          svg_focus.append("text").attr("y",275).append("a").attr("xlink:href", "http://images.google.com/searchbyimage?image_url=" + d.image)
            .text("Reverse Image Search");

        })
        //Tooltip on hover
        .append("svg:title")
          .text(function(d) { return "Painting: " + d.painting + "\nArtist: " + d.artist + "\nRecord number: " + d.record; });

    //Default layout is force
    force_layout();

    // var svg_bar = d3.select(".bar").append("svg").attr("width",400).attr("height",bar_height);
    // making the bar graph
    // console.log(json);

  // creates bar graph (artist vs painting)
    function createArtistMissing(data) {

      // make the artist_obj.missing_paintings.length the height of the bar chart per name of artist

      var y = d3.scale.linear()
        .domain([0, d3.max(artist_obj)])
        .range([bar_height,0])

      var x = d3.scale.ordinal()
        .domain(artist_obj)
        .range([0, svg_barwidth])

      console.log(x("Benvenuto di Giovanni"));
      console.log(y(3))

      svg_bar.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + (bar_height - 25) + ")")
        .call(x)
        .append("text")
        .text("artists")

      svg_bar.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(" + (svg_barwidth - 50) + ", -25)")
        .call(y)
        .append("text")
        .text("total missing paintings")

      svg_bar
        .selectAll("g")
          .data(data)
        .enter()
          .append("g")
          .attr("transform", function(d, i) {
            return "translate(0," + i * bar_height + ")";
          });

      svg_bar.selectAll(".bar")
        .data(data)
        .enter()
        .append("rect")
        .attr("width", svg_barwidth / data.length)
        .attr("height", function(d) {
          return bar_height - y(d);
        })
        .attr("fill-opacity", .20);
    }

    createArtistMissing(artist_obj);

  })
}

// function that updates the bar graph
// var updateBarGraph = function(json){

//    detailVis.selectAll("rect")
//        .data(completeDataSet[ID].hourly)
//        .transition()
//        .duration(1000)
//        .attr("y", function(d) { return yScale(d) - 25; })
//        .attr("height", function(d) { return detailVisHeight - yScale(d); })
//        .attr("width", 10)
//        .attr("fill-opacity", .20);

//     detailVis.selectAll(".title")
//         .text(data.STATION);
// }

</script>
</body>
</html>