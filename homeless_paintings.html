<!DOCTYPE html>
<meta charset="utf-8">
<title>Homeless Paintings of the Italian Renaissance</title>
<style>

  body {
     font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif; 
     font-weight: 300;    
     font-size: 10pt;    
  }

  .link {
    stroke: gray;
    stroke-width: 1.5px;
  }

  .node {
    fill: blue;
    stroke: #000;
    stroke-width: 1px;
  }

  .node:hover {
    fill: red;
  }

  a {text-decoration: underline;}
  a:link {fill: #0000FF;}
  a:visited {fill: #800080;}
  a:active {fill: #FF0000;}

</style>
<body>

<h4>
Homeless Paintings of the Italian Renaissance<br>
Jason Mahr, Linda Song, and Ben Zauzmer
</h4>

<script src="http://d3js.org/d3.v3.min.js"></script>
  <form>
  Layout:
    <label><input type="radio" name="layout" value="force" checked> Force</label>
    <label><input type="radio" name="layout" value="radial"> Radial</label>
    <label><input type="radio" name="layout" value="map"> Map</label>
    <label><input type="radio" name="layout" value="timeline"> Timeline</label>
  </form>
  
  <table border="1">
    <tr>
      <td class="vis" rowspan="2"></td>
      <td class="filters"></td>
      <td class="focus"></td>
    </tr>
    <tr>
      <td class="bar" colspan="2">
      <!-- // making menu dropdown for the bar graph -->
      <p id="menu"><b>Bar Graph</b><br>Select series: <select>
        <option value="Years">Years vs Number of Paintings Missing</option>
        <option value="Artists">Artist vs Number of Paintings Missing</option></select>
      </td>
    </tr>
  </table>

<script>

//Margins, where bar_height is the height of the bar graph cell
var width = 750, height = 500, bar_height = 200;

//Create one svg for each of the four cells
var svg_vis = d3.select(".vis").append("svg").attr("width", width).attr("height", height);
var svg_filters = d3.select(".filters").append("svg").attr("width",200).attr("height",height-bar_height);
var svg_focus = d3.select(".focus").append("svg").attr("width",200).attr("height",height-bar_height);
var svg_bar = d3.select(".bar").append("svg").attr("width",400).attr("height",bar_height);

//Add filler text to the non-vis cells
svg_filters.append("text").text("The filters will go here.").attr("y",50);
svg_focus.append("text").text("Click on a node!").attr("y",50);
svg_bar.append("text").text("The bar graph will go here.").attr("y",50);

//Create structure for force diagram
var graph = {nodes:[], links:[]};

//Load data - data_text is only the first 10 entries
//Will be changed to a CSV
d3.json("data_test.txt", function(json) {

  //Loop through paintings
  for (var i = 0; i < 10; i++) {
   
    //Add node for each painting
    graph.nodes.push({
      painting: json[i]['original']['titleInfo'][0]['title'][0],
      artist: json[i]['original']['name'][0]['namePart'][0],
      record: i,
      image: json[i]['parsed']['image'][0]
    });
  }

  //Function that returns intersection of two arrays
  function intersect(a, b) {
    var t;
    if (b.length > a.length) t = b, b = a, a = t;
    return a.filter(function (e) {
        if (b.indexOf(e) !== -1) return true;
    });
  }

  //Loop through nodes
  for(var i = 0; i < graph.nodes.length; i++) {

    //Loop through nodes a second time for pairwise comparison
    for (var j = i + 1; j < graph.nodes.length; j++) {

      //Check if both nodes have topics section
      if ('topics' in json[i]['parsed'] && 'topics' in json[j]['parsed']) {

        //Determine size of intersection
        var overlap = intersect(json[i]['parsed']['topics'],json[j]['parsed']['topics']).length;

        //Check if the nodes share any topics
        if (overlap) {

          //Add link if the nodes share a topic
          graph.links.push({"source": i, "target": j, "overlap": overlap});
        }
      }
    }
  }

  //Generate the force layout
  var force = d3.layout.force()
      .size([width, height])
      .charge(-50)
      .linkDistance(200)
      .on("tick", tick)
      .on("start", function(d) {})
      .on("end", function(d) {})

  //Part of the force layout
  function tick(d) {

    graph_update(0);
  }

  //Start force layout if radio button selected
  function force_layout() {

    force.nodes(graph.nodes)
        .links(graph.links)
        .start();
  }

  //Start radial layout if radio button selected
  function radial_layout() {

    force.stop();

    var r = height/2;

    var arc = d3.svg.arc().outerRadius(r);

    var pie = d3.layout.pie()
    .sort(function(a, b) { return a.cat - b.cat;})
            .value(function(d, i) { return 1; }); // equal share for each point

    graph.nodes = pie(graph.nodes).map(function(d, i) {
      d.innerRadius = 0;
      d.outerRadius = r;
      d.data.x = arc.centroid(d)[0]+height/2;
      d.data.y = arc.centroid(d)[1]+width/2;
      d.data.endAngle = d.endAngle; 
      d.data.startAngle = d.startAngle; 
      return d.data;
    })

    graph_update(500);
  }

  //Update graph via smooth transition
  function graph_update(delay) {

    link.transition().duration(delay)
        .attr("x1", function(d) { return d.target.x; })
        .attr("y1", function(d) { return d.target.y; })
        .attr("x2", function(d) { return d.source.x; })
        .attr("y2", function(d) { return d.source.y; });

    node.transition().duration(delay)
        .attr("transform", function(d) { 
          return "translate("+d.x+","+d.y+")"; 
        });
  }

  //Enable radio buttons (last two are commented out until implementation)
  d3.select("input[value=\"force\"]").on("click", force_layout);
  d3.select("input[value=\"radial\"]").on("click", radial_layout);
  //d3.select("input[value=\"map\"]").on("click", map_layout);
  //d3.select("input[value=\"timeline\"]").on("click", timeline_layout);
  
  //Create nodes
  var node = svg_vis.selectAll(".node")
                .data(graph.nodes)
              .enter()
                .append("g").attr("class", "node");

  //Create links
  var link = svg_vis.selectAll(".link")
              .data(graph.links)
              .enter().insert("svg:line","g.node")
              .attr("class", "link")
              //Link thickness by number of overlapping topics
              .style("stroke-width", function(d) {return d.overlap;});

  //Add circles to nodes
  node.append("circle")
      .attr("r", 5)
      .on('click', function(d) {

        //Remove previous image and text from focus
        svg_focus.selectAll("image").remove();
        svg_focus.selectAll("text").remove();

        //Add clicked image to focus
        svg_focus.append("svg:image")
          .attr("xlink:href",d.image)
          .attr("width",125)
          .attr("height",125)
          .attr("x",35)
          .attr("y",50)
        
        //Add clicked text to focus
        svg_focus.append("text").text("Painting: " + d.painting).attr("y",200);
        svg_focus.append("text").text("Artist: " + d.artist).attr("y",225);
        svg_focus.append("text").text("Record number: " + d.record).attr("y",250);
        svg_focus.append("text").attr("y",275).append("a").attr("xlink:href", "http://images.google.com/searchbyimage?image_url=" + d.image)
          .text("Reverse Image Search");

      })
      //Tooltip on hover
      .append("svg:title")
        .text(function(d) { return "Painting: " + d.painting + "\nArtist: " + d.artist + "\nRecord number: " + d.record; });

  //Default layout is force
  force_layout();

  // var svg_bar = d3.select(".bar").append("svg").attr("width",400).attr("height",bar_height);
  // making the bar graph
  console.log(json);
  createBarGraph(json);

})

// function that updates the bar graph
// var updateBarGraph = function(json){

//    detailVis.selectAll("rect")
//        .data(completeDataSet[ID].hourly)
//        .transition()
//        .duration(1000)
//        .attr("y", function(d) { return yScale(d) - 25; })
//        .attr("height", function(d) { return detailVisHeight - yScale(d); })
//        .attr("width", 10)
//        .attr("fill-opacity", .20);

//     detailVis.selectAll(".title")
//         .text(data.STATION);
// }

// function to create the bar graph
var createBarGraph = function(json){

    detailVis
        .append("text")
        .attr("class","title")
        .attr("x", (detailVisWidth / 2))             
        .attr("y", 20)
        .attr("text-anchor", "middle")  
        .style("font-size", "16px") 
        .text(json.STATION);;

        console.log(json.STATION);

    xScale.domain([0,24]);
    yScale.domain([0, 20000000]);

    var xAxis = d3.svg.axis()
        .scale(xScale)
        .orient("bottom")
        // .attr("transform", "translate(" + detailVisHeight + ",0)");

    var yAxis = d3.svg.axis()
        .scale(yScale)
        .orient("right");

    detailVis.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + (detailVisHeight - 25) + ")")
        .call(xAxis)
        .append("text")
        // .attr("transform", "translate(0," + detailVisHeight + ")")
        // .style("text-anchor", "end")
        .text("hours");

    detailVis.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(" + (detailVisWidth - 50) + ", -25)")
        .call(yAxis)
        // .ticks(10)
        .append("text")
        .attr("y", 8)
        .attr("dy", ".71em")
        // .style("text-anchor", "end")
        .text("sum");
        // .attr("transform", "translate(");


    detailVis.selectAll(".bar")
        .data(completeDataSet[ID].hourly)
        .enter()
        .append("rect")
        .attr("x", function(d,i) { 
            return xScale(i);
        })
        .attr("y", function(d) {
            // console.log(d);
            // console.log(yScale(d));
            return yScale(d) - 25;
        })
        .attr("height", function(d) {
            return detailVisHeight - yScale(d) ;
        })
        .attr("width", 10)
        .attr("fill-opacity", .20);

}

</script>
</body>
</html>